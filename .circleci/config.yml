version: 2.1

setup: true  # Habilita configuración dinámica

orbs:
  continuation: circleci/continuation@0.1.2  # Orb oficial de CircleCI para pipelines dinámicos

parameters:
  pipeline_config:
    type: string
    default: config_1.yml  # Usa config_1.yml como predeterminado

workflows:
  setup:
    jobs:
      - trigger_pipeline:  # Job que maneja la lógica y validación
          pipeline_config: << pipeline.parameters.pipeline_config >>

jobs:
  trigger_pipeline:
    docker:
      - image: cimg/base:stable  # Imagen base ligera con herramientas CLI
    parameters:
      pipeline_config:
        type: string
    steps:
      - checkout  # Clona el código del repositorio
      - run:
          name: Verificar Archivos en .circleci/
          command: |
            echo "Verificando archivos en .circleci/"
            ls -la .circleci/
      - run:
          name: Validar y Continuar con Configuración Dinámica
          command: |
            CONFIG_FILE=".circleci/<< parameters.pipeline_config >>"
            if [ -f "$CONFIG_FILE" ]; then
              echo "✅ Archivo encontrado: $CONFIG_FILE"
              circleci config validate "$CONFIG_FILE"
              circleci continuation continue -c "$CONFIG_FILE"
            else
              echo "❌ ERROR: Archivo $CONFIG_FILE no encontrado"
              exit 1
            fi
