version: 2.1
setup: true

orbs:
  continuation: circleci/continuation@0.1.2

parameters:
  jobs_file:
    type: string
    default: config_cuenta1.yml
  workflow_files_csv:
    type: string
    default: "approve.yaml,usuarios63-iam.yaml"

workflows:
  setup:
    jobs:
      # üëá No pases argumentos aqu√≠; l√©elos dentro del job
      - trigger_pipeline

jobs:
  trigger_pipeline:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout

      - run:
          name: Instalar yq
          command: |
            mkdir -p ~/bin
            YQ_VERSION=v4.43.1
            wget https://github.com/mikefarah/yq/releases/download/$YQ_VERSION/yq_linux_amd64 -O ~/bin/yq
            chmod +x ~/bin/yq
            echo 'export PATH="$HOME/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
            yq --version

      - run:
          name: Resolver par√°metros desde CIRCLE_PIPELINE_PARAMETERS
          command: |
            echo "CIRCLE_PIPELINE_PARAMETERS: $CIRCLE_PIPELINE_PARAMETERS"
            # Lee los par√°metros del pipeline (con fallback a defaults del config)
            JOBS_FILE="$(echo "$CIRCLE_PIPELINE_PARAMETERS" | jq -r '.jobs_file // empty')"
            WF_CSV="$(echo "$CIRCLE_PIPELINE_PARAMETERS" | jq -r '.workflow_files_csv // empty')"
            # Fallback a defaults del propio config si vienen vac√≠os
            [[ -n "$JOBS_FILE" ]] || JOBS_FILE="<< pipeline.parameters.jobs_file >>"
            [[ -n "$WF_CSV"   ]] || WF_CSV="<< pipeline.parameters.workflow_files_csv >>"
            echo "Using jobs_file=$JOBS_FILE"
            echo "Using workflow_files_csv=$WF_CSV"
            # Exporta para siguientes pasos
            echo "export JOBS_FILE=\"$JOBS_FILE\"" >> $BASH_ENV
            echo "export WF_CSV=\"$WF_CSV\""       >> $BASH_ENV
            source $BASH_ENV

      - run:
          name: Combinar jobs + workflows seleccionados
          command: |
            bash .circleci/build_config.sh "$JOBS_FILE" "$WF_CSV"

      - continuation/continue:
          configuration_path: .circleci/config_final.yml