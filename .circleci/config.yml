version: 2.1
setup: true

orbs:
  continuation: circleci/continuation@0.1.2

parameters:
  jobs_file:
    type: string
    default: config_cuenta1.yml
  workflow_files_csv:
    type: string
    # ejemplo: "approve.yaml,usuarios63-iam.yaml"
    default: "approve.yaml,usuarios63-iam.yaml"

workflows:
  setup:
    jobs:
      - trigger_pipeline:
          jobs_file: << pipeline.parameters.jobs_file >>
          workflow_files_csv: << pipeline.parameters.workflow_files_csv >>

jobs:
  trigger_pipeline:
    docker:
      - image: cimg/base:stable
    parameters:
      jobs_file:
        type: string
      workflow_files_csv:
        type: string
    steps:
      - checkout
      - run:
          name: Instalar yq
          command: |
            mkdir -p ~/bin
            YQ_VERSION=v4.43.1
            wget https://github.com/mikefarah/yq/releases/download/$YQ_VERSION/yq_linux_amd64 -O ~/bin/yq
            chmod +x ~/bin/yq
            echo 'export PATH="$HOME/bin:$PATH"' >> $BASH_ENV
            source $BASH_ENV
            yq --version
      - run:
          name: Combinar jobs + workflows seleccionados
          command: |
            bash .circleci/build_config.sh "<< parameters.jobs_file >>" "<< parameters.workflow_files_csv >>"
      - continuation/continue:
          configuration_path: .circleci/config_final.yml