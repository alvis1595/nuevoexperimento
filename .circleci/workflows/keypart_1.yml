parameters:
  workflow_file:
    type: string
    default: keypart_1.yaml
  stacks_to_run:
    type: string
    default: "all"

workflows:
  iac-compute:
    jobs:
      - approval:
          name: Tech lead approvement prod 🤯🙊💤
          type: approval
          filters:
            branches:
              only: main

      - deploy:
          name: Deploy IAC Key part 🧙‍♂️
          DEPLOY_ENV: dev
          TEMPLATE_FILE_NAME: template/key.yaml
          RESOURCE_NAME: key
          requires:
            - Tech lead approvement prod 🤯🙊💤
          filters:
            branches:
              only: main
          context:
            - idaws
            - clavaws
          when:
            condition:
              or:
                - equal: [ "part", << pipeline.parameters.stacks_to_run >> ]
                - equal: [ "all", << pipeline.parameters.stacks_to_run >> ]

      - deploy:
          name: Deploy IAC usuario
          DEPLOY_ENV: dev
          TEMPLATE_FILE_NAME: template/usuario.yaml
          RESOURCE_NAME: usuario-iam
          requires:
            - Tech lead approvement prod 🤯🙊💤
          filters:
            branches:
              only: main
          context:
            - idaws
            - clavaws
          when:
            condition:
              or:
                - equal: [ "usuario", << pipeline.parameters.stacks_to_run >> ]
                - equal: [ "all", << pipeline.parameters.stacks_to_run >> ]