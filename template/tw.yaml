AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Crea un AWS Transit Gateway (TGW) y configura adjuntos, rutas y propagaciÃ³n de rutas entre VPCs.

Resources:
  # ðŸš€ Transit Gateway (TGW)
  MyTransitGateway:
    Type: AWS::EC2::TransitGateway
    Properties:
      Description: "Transit Gateway para interconectar VPCs"
      AmazonSideAsn: 64512
      AutoAcceptSharedAttachments: enable
      DefaultRouteTableAssociation: enable
      DefaultRouteTablePropagation: enable
      DnsSupport: enable
      VpnEcmpSupport: enable

  # ðŸš€ TGW Route Table
  TGWRouteTable:
    Type: AWS::EC2::TransitGatewayRouteTable
    Properties:
      TransitGatewayId: !Ref MyTransitGateway

  # ðŸš€ TGW Attachment para VPC1
  TGWAttachmentVPC1:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !Ref MyTransitGateway
      VpcId: !ImportValue VPC1-ID
      SubnetIds:
        - !ImportValue VPC1-PublicSubnet1
        - !ImportValue VPC1-PublicSubnet2

  # ðŸš€ TGW Attachment para VPC2
  TGWAttachmentVPC2:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !Ref MyTransitGateway
      VpcId: !ImportValue VPC2-ID
      SubnetIds:
        - !ImportValue VPC2-PublicSubnet1
        - !ImportValue VPC2-PublicSubnet2

  # ðŸš€ Asociar Attachments a TGW Route Table
  TGWRouteTableAssociationVPC1:
    Type: AWS::EC2::TransitGatewayRouteTableAssociation
    Properties:
      TransitGatewayAttachmentId: !Ref TGWAttachmentVPC1
      TransitGatewayRouteTableId: !Ref TGWRouteTable

  TGWRouteTableAssociationVPC2:
    Type: AWS::EC2::TransitGatewayRouteTableAssociation
    Properties:
      TransitGatewayAttachmentId: !Ref TGWAttachmentVPC2
      TransitGatewayRouteTableId: !Ref TGWRouteTable

  # ðŸš€ Propagar Rutas en la TGW Route Table
  TGWRoutePropagationVPC1:
    Type: AWS::EC2::TransitGatewayRouteTablePropagation
    Properties:
      TransitGatewayAttachmentId: !Ref TGWAttachmentVPC1
      TransitGatewayRouteTableId: !Ref TGWRouteTable

  TGWRoutePropagationVPC2:
    Type: AWS::EC2::TransitGatewayRouteTablePropagation
    Properties:
      TransitGatewayAttachmentId: !Ref TGWAttachmentVPC2
      TransitGatewayRouteTableId: !Ref TGWRouteTable

  # ðŸš€ Modificar la Route Table de VPC1 para usar el TGW
  VPC1RouteToTGW:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !ImportValue VPC1-RouteTableID
      DestinationCidrBlock: !ImportValue VPC2-CIDR
      TransitGatewayId: !Ref MyTransitGateway

  # ðŸš€ Modificar la Route Table de VPC2 para usar el TGW
  VPC2RouteToTGW:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !ImportValue VPC2-RouteTableID
      DestinationCidrBlock: !ImportValue VPC1-CIDR
      TransitGatewayId: !Ref MyTransitGateway

Outputs:
  TransitGatewayID:
    Description: "ID del Transit Gateway creado"
    Value: !Ref MyTransitGateway
    Export:
      Name: TGW-ID

  TGWRouteTableID:
    Description: "ID de la Route Table del TGW"
    Value: !Ref TGWRouteTable
    Export:
      Name: TGW-RouteTableID
